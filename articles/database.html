<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Database • singlecellviz</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Database">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">singlecellviz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/usage.html">Usage</a></li>
    <li><a class="dropdown-item" href="../articles/database.html">Database</a></li>
    <li><a class="dropdown-item" href="../articles/development.html">Development</a></li>
    <li><a class="dropdown-item" href="../articles/deployment.html">Deployment</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metzger-chambon/singlecellviz/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Database</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/metzger-chambon/singlecellviz/blob/master/vignettes/database.Rmd" class="external-link"><code>vignettes/database.Rmd</code></a></small>
      <div class="d-none name"><code>database.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="personalized-studies-file">Personalized studies file<a class="anchor" aria-label="anchor" href="#personalized-studies-file"></a>
</h2>
<p>By default, the app is run on a very small subset of pbmc3k dataset.
To visualize other datasets of interest, they need to be available
within a folder in a TileDB-SOMA format (see <a href="#tiledb-soma">TileDB-SOMA</a>).</p>
<p>A txt file summarizing all available datasets should be created. The
txt file is in the following format:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">title</span>    output    rds    description    doi    date    nsamples    nfeatures    ncells</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">Study</span> 1    /path/to/tiledb    path/to/rds    Some description    Some doi    DD/MM/YYYY    number_of_samples    number_of_features    number_of_cells</span></code></pre></div>
<p>where each row is an available dataset, and the separators are
tabs.</p>
<p>It can be automatically generated with <code><a href="../reference/update_summary.html">update_summary()</a></code>
(see <a href="#updating-the-summary">Updating the summary</a>).</p>
<p>Finally, you have to generate a data.frame from the txt file and pass
it as argument to <code><a href="../reference/run_app.html">run_app()</a></code> like so:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mystudies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">"path/to/data_summary.txt"</span>,</span>
<span>                      header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                      sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="co">## Optional: change the path of the output and rds if not in the same folder as the app</span></span>
<span><span class="co"># mystudies$output &lt;- file.path("path/to/datasets/folder", mystudies$output)</span></span>
<span><span class="co"># mystudies$rds &lt;- file.path("path/to/datasets/folder", mystudies$rds)</span></span>
<span></span>
<span><span class="fu">singlecellviz</span><span class="fu">::</span><span class="fu">run_dev</span><span class="op">(</span>studies <span class="op">=</span> <span class="va">mystudies</span><span class="op">)</span></span>
<span>        </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="structure-of-the-database">Structure of the database<a class="anchor" aria-label="anchor" href="#structure-of-the-database"></a>
</h2>
<p>There should be a folder (e.g. named <code>db/</code>), where each
dataset has its own sub-folder named <code>DATASET_NAME/</code> (replace
<code>DATASET_NAME</code> with the name of the dataset).</p>
<p>Inside of each dataset folder, there should be:</p>
<ul>
<li>
<code>tiledb/</code> folder containing various folders and files
corresponding to the tiledb database (see sections <a href="#tiledb-soma">TileDB-SOMA</a> and <a href="#creating-tiledb">Creating tiledb</a>)</li>
<li>
<code>object.rds</code> file containing the Seurat object, the
markers and comparison tables that the user will be able to directly
download in the app (see section <a href="#rds-object">rds
object</a>)</li>
<li>
<code>create_rds.R</code> file containing the script that cleans and
process the original data into a compatible dataset for the app (see
section <a href="#create_rds.r-file">create_rds.R file</a>)</li>
<li>
<code>config.yaml</code> file containing metadata about the dataset
such as the title, the description, etc (see section <a href="#config.yaml-file">config.yaml file</a>)</li>
</ul>
<div class="section level3">
<h3 id="tiledb-soma">TileDB-SOMA<a class="anchor" aria-label="anchor" href="#tiledb-soma"></a>
</h3>
<p>The datasets are saved under <code>DATASET_NAME/tildeb/</code> in the
format provided by <a href="https://single-cell-data.github.io/TileDB-SOMA/index.html" class="external-link">TileDB-SOMA</a>.</p>
<p>TileDB-SOMA is a R package developed to store and access single-cell
data at scale. Indeed, when working with a Seurat object, the whole
object is loaded, even though only parts of it are needed (not all genes
are going to be visualized for example). In the case of our app, meant
to be deployed on a server, loading the full Seurat object would be too
heavy on the RAM usage. Thus we decided to use TileDB-SOMA.</p>
<p>In addition to the <a href="https://single-cell-data.github.io/TileDB-SOMA/articles/soma-objects.html" class="external-link">original
TileDB-SOMA structure</a> for Seurat objects, the app adds on the two
following SOMACollections:</p>
<ul>
<li><code>markers</code></li>
<li><code>comparison</code></li>
</ul>
<p>Both SOMACollections contains a given number of sub-SOMACollection
(one for each markers identity/comparisons). Every sub-SOMACollection
contains two SOMADataFrame:</p>
<ul>
<li>
<code>result</code>, the result of Seurat’s
<code>FindAllMarkers</code> (for the SOMACollections
<code>markers</code>) or Seurat’s <code>FindMarkers</code> (for the
SOMACollections <code>comparison</code>)</li>
<li>
<code>expression</code>, the result of Seurat’s
<code>PseudobulkExpression</code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="rds-object">rds object<a class="anchor" aria-label="anchor" href="#rds-object"></a>
</h3>
<p>The rds object under <code>DATASET_NAME/object.rds</code> is the one
that will be used to create the tiledb folder. It is also the one that
the user will be able to download in the app. It is a list of the
following elements:</p>
<ul>
<li>
<code>seuratObj</code>, the Seurat object</li>
<li>
<code>markers</code>, a list with the table of
<code>FindAllMarkers</code> and <code>PseudobulkExpression</code>
</li>
<li>
<code>comparison</code>, a list with the table of
<code>FindMarkers</code> and <code>PseudobulkExpression</code>
</li>
</ul>
<p>See section <a href="#creating-the-rds">Creating the rds</a>.</p>
</div>
<div class="section level3">
<h3 id="config-yaml-file">config.yaml file<a class="anchor" aria-label="anchor" href="#config-yaml-file"></a>
</h3>
<p>The <code>DATASET_NAME/config.yaml</code> will be used to create
summary of all datasets (see section <a href="#updating-the-summary">Updating the summary</a>). It must have the
following structure, and at least the following elements:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">title:</span> <span class="st">'Study 1'</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="ex">description:</span> <span class="st">'Some description'</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="ex">doi:</span> <span class="st">'Some doi'</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="ex">date:</span> DD/MM/YYYY</span></code></pre></div>
<p>See section <a href="#creating-config.yaml">Creating
config.yaml</a>.</p>
</div>
<div class="section level3">
<h3 id="create_rds-r-file">create_rds.R file<a class="anchor" aria-label="anchor" href="#create_rds-r-file"></a>
</h3>
<p>To keep a note of how every dataset was created, it is strongly
advised to write a script with the code run into
<code>DATASET_NAME/create_rds.R</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-a-new-dataset">Adding a new dataset<a class="anchor" aria-label="anchor" href="#adding-a-new-dataset"></a>
</h2>
<p>If you are adding to a pre-existing database, take a look at some
<code>create_rds.R</code> of existing datasets to better grasp how you
can easily clean the Seurat object, create necessary tables, convert to
TileDB-SOMA format, and create a <code>config.yaml</code> file. At the
end, add the dataset to the txt file summarizing all datasets by running
<code><a href="../reference/update_summary.html">singlecellviz::update_summary()</a></code>.</p>
<p>Save everything that was run in the <code>create_rds.R</code> file in
this dataset sub-folder!</p>
<p>For more explanation, read the following sections.</p>
<div class="section level3">
<h3 id="cleaning-the-seurat-object">Cleaning the Seurat object<a class="anchor" aria-label="anchor" href="#cleaning-the-seurat-object"></a>
</h3>
<p>To add a new dataset you will need to clean the Seurat object, for
example:</p>
<ul>
<li>remove unnecessary columns in <code>@meta.data</code>.</li>
<li>check that the columns in <code>@meta.data</code> are in the
expected format (generally <code>numeric</code> or
<code>factors</code>).</li>
<li>remove unnecessary elements in <code>@reductions</code>. You can use
<code><a href="https://satijalab.org/seurat/reference/DietSeurat.html" class="external-link">Seurat::DietSeurat()</a></code> to facilitate this process.</li>
<li>remove unnecessary elements in <code>@assays</code>, there should
only be one at the end (typically <code>RNA</code>) which is the one
used for the explore tab (what Seurat typically uses for DimPlot,
VlnPlot, DotPlot). You can use <code><a href="https://satijalab.org/seurat/reference/DietSeurat.html" class="external-link">Seurat::DietSeurat()</a></code> to
facilitate this process.</li>
<li>remove <code>scale.data</code> of the <code>@assays</code> left at
the very end. It is usually heavy, and not useful for visualization. But
only do it at the end, as it is used to run
<code>PseudobulkExpression</code> in the following steps (see the next
section <a href="#create-markers-and-comparison-tables">Create markers
and comparison tables</a>).</li>
</ul>
<p>In general, think of keeping only what you want to show in the app,
and lighten the Seurat object.</p>
</div>
<div class="section level3">
<h3 id="create-markers-and-comparison-tables">Create markers and comparison tables<a class="anchor" aria-label="anchor" href="#create-markers-and-comparison-tables"></a>
</h3>
<p>To ease the process of creating the tables, the functions
<code><a href="../reference/compute_markers.html">singlecellviz::compute_markers()</a></code> and
<code><a href="../reference/compute_comparison.html">singlecellviz::compute_comparison()</a></code> have been developed.
Check the help of each function for more information and examples.</p>
<p>They are basically wrappers for
<code><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html" class="external-link">Seurat::FindAllMarkers()</a></code>,
<code><a href="https://satijalab.org/seurat/reference/FindMarkers.html" class="external-link">Seurat::FindMarkers()</a></code> and
<code><a href="https://satijalab.org/seurat/reference/PseudobulkExpression.html" class="external-link">Seurat::PseudobulkExpression()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="creating-the-rds">Creating the rds<a class="anchor" aria-label="anchor" href="#creating-the-rds"></a>
</h3>
<p>The <code>rds</code> object structure is described in <a href="#rds-object">rds object</a>. If you followed the previous
sections, you only have to create a list and save it like so:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Don't forget to remove `scale.data` from the Assays left in the Seurat object!</span></span>
<span><span class="va">rds_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>seuratObj <span class="op">=</span> <span class="va">x</span>, </span>
<span>                markers <span class="op">=</span> <span class="va">y</span>, </span>
<span>                comparison <span class="op">=</span> <span class="va">z</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">rds_obj</span>, <span class="st">"db/DATASET_NAME/object.rds"</span><span class="op">)</span></span></code></pre></div>
<p>where:</p>
<ul>
<li>
<code>x</code> is the cleaned Seurat object</li>
<li>
<code>y</code> is the result of
<code><a href="../reference/compute_markers.html">singlecellviz::compute_markers()</a></code>
</li>
<li>
<code>z</code> is the result of
<code><a href="../reference/compute_comparison.html">singlecellviz::compute_comparison()</a></code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="creating-tiledb">Creating tiledb<a class="anchor" aria-label="anchor" href="#creating-tiledb"></a>
</h3>
<p>The TileDB-SOMA database can be easily created with the function
<code><a href="../reference/populate_tiledb.html">singlecellviz::populate_tiledb()</a></code>.</p>
<p>It takes as input <code>dataset_dir</code>, the path folder of the
dataset. It gives no output. It will look for the
<code>object.rds</code> present in <code>dataset_dir</code>, and create
the TileDB-SOMA database in a folder called <code>tildeb</code> inside
of <code>dataset_dir</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/populate_tiledb.html">populate_tiledb</a></span><span class="op">(</span>dataset_dir <span class="op">=</span> <span class="st">"db/DATASET_NAME/"</span>,</span>
<span>                force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-config-yaml">Creating config.yaml<a class="anchor" aria-label="anchor" href="#creating-config-yaml"></a>
</h3>
<p>You should now create the <code>config.yaml</code> in this dataset
folder.</p>
<p>This can be done easily like so:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create yaml</span></span>
<span><span class="va">yaml_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"title"</span> <span class="op">=</span> <span class="st">"Study 1"</span>,</span>
<span>     <span class="st">"description"</span> <span class="op">=</span> <span class="st">"Some &lt;b&gt;description&lt;/b&gt;"</span>, <span class="co"># HTML is accepted</span></span>
<span>     <span class="st">"doi"</span> <span class="op">=</span> <span class="st">"Some doi"</span>,</span>
<span>     <span class="st">"date"</span> <span class="op">=</span> <span class="st">"DD/MM/YYYY"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">yaml</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yaml/man/write_yaml.html" class="external-link">write_yaml</a></span><span class="op">(</span><span class="va">yaml_content</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"db/DATASET_NAME/"</span>, <span class="st">"config.yaml"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Make sure that your list contains all elements needed in
<code>config.yaml</code> (see section <a href="#config.yaml-file">config.yaml file</a>).</p>
</div>
<div class="section level3">
<h3 id="updating-the-summary">Updating the summary<a class="anchor" aria-label="anchor" href="#updating-the-summary"></a>
</h3>
<p>The txt file summarizing all datasets can be easily updated with the
code in <code><a href="../reference/update_summary.html">singlecellviz::update_summary()</a></code>. It is this file
that can be uploaded as data.frame, in order to pass the object as
<code>study</code> parameter to
<code><a href="../reference/run_app.html">singlecellviz::run_app()</a></code>.</p>
<p>It automatically searches for all available <code>config.yaml</code>,
<code>object.rds</code>and <code>tiledb/</code> in each subfolder of the
given db_dir (e.g. <code>db/</code>). Only subfolders with
<code>config.yaml</code> are processed.</p>
<p>It summarizes mandatory elements (e.g. the title, description…) from
the <code>config.yaml</code>, as well as retrieves the number of cells,
features and samples. By default, it will look for the equivalent of an
<code>RNA</code> assay in the TileDB-SOMA database (if it does not exist
it will take the first assay available). This retrieves the number of
cells and features. Moreover, it will look for a metadata column called
<code>orig.ident</code> (if it does not exist it will take the first
available metadata column) and assess the number of unique values for
this column to compute the number of samples.</p>
<p>The order of the datasets is alphanumerical according to the name of
the folder containing them. Therefore, to change the order of the
datasets, simply add the desired position at the beginning of the folder
name (e.g. if the folder <code>zzz/</code> contains the first dataset to
show, rename it to <code>1_zzz/</code>).</p>
<p>The function <code><a href="../reference/update_summary.html">singlecellviz::update_summary()</a></code> can also be
used to modify the txt file summarizing the datasets without modifying
it manually. For example to change a description, first modify the
corresponding <code>config.yaml</code> and then re-run
<code><a href="../reference/update_summary.html">singlecellviz::update_summary()</a></code>.</p>
<p>It is recommended to run the
<code><a href="../reference/update_summary.html">singlecellviz::update_summary()</a></code> instead of changing the
file manually. First of all, it will prevent from breaking the file due
to manual error (for example by not using tabs as separator). Second, it
will be a first test to verify that the TileDB-SOMA database works for
every dataset, as it retrieves the number of cells, features and samples
available by querying each database.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valentine Gilbart.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
